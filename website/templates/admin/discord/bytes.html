{% extends "admin/base.html" %}

{% block title %}Bytes System - Smarter.Dev Admin{% endblock %}

{% block content %}
<div class="bytes-page">
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('configuration')">Configuration</button>
        <button class="tab-btn" onclick="switchTab('roles')">Role Rewards</button>
        <button class="tab-btn" onclick="switchTab('history')">History</button>
    </div>

    <!-- Configuration Tab -->
    <div id="configuration" class="tab-content active">
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Server Configurations</h2>
            </div>
            
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Server</th>
                            <th>Starting Balance</th>
                            <th>Daily Earning</th>
                            <th>Max Give Amount</th>
                            <th>Cooldown (minutes)</th>
                            <th>Squad Join Min Bytes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for config in configs %}
                        <tr>
                            <td>{{ guild_names.get(config.guild_id, 'Unknown') }}</td>
                            <td>{{ config.starting_balance }}</td>
                            <td>{{ config.daily_earning }}</td>
                            <td>{{ config.max_give_amount }}</td>
                            <td>{{ config.cooldown_minutes }}</td>
                            <td>{{ config.squad_join_bytes_required }}</td>
                            <td>
                                <button class="btn btn-sm btn-outline" onclick="editConfig('{{ config|tojson|safe }}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Role Rewards Tab -->
    <div id="roles" class="tab-content">
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Role Rewards</h2>
                <button class="btn btn-primary" onclick="openRoleModal()">
                    <i class="fas fa-plus"></i> Add Role Reward
                </button>
            </div>
            
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Server</th>
                            <th>Role Name</th>
                            <th>Role ID</th>
                            <th>Bytes Required</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for role in roles %}
                        <tr>
                            <td>{{ guild_names.get(role.guild_id, 'Unknown') }}</td>
                            <td>{{ role.role_name }}</td>
                            <td>{{ role.role_id }}</td>
                            <td>{{ role.bytes_required }}</td>
                            <td>
                                <button class="btn btn-sm btn-outline" onclick="editRole('{{ role|tojson|safe }}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline btn-danger" onclick="deleteRole('{{ role.id }}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- History Tab -->
    <div id="history" class="tab-content">
        <div class="section">
            <div class="section-header">
                <h2 class="section-title">Bytes History</h2>
                <div class="filter-controls">
                    <select id="guildFilter" class="form-select" onchange="filterHistory()">
                        <option value="all">All Servers</option>
                        {% for guild_id, guild_name in guild_names.items() %}
                        <option value="{{ guild_id }}">{{ guild_name }}</option>
                        {% endfor %}
                    </select>
                    <input type="text" id="searchFilter" class="form-input" placeholder="Search..." onkeyup="filterHistory()">
                </div>
            </div>
            
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>From</th>
                            <th>To</th>
                            <th>Server</th>
                            <th>Amount</th>
                            <th>Reason</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody id="historyTable">
                        {% for transaction in transactions %}
                        <tr>
                            <td>{{ transaction.giver.username if transaction.giver else 'System' }}</td>
                            <td>{{ transaction.receiver.username }}</td>
                            <td>{{ guild_names.get(transaction.guild_id, 'Unknown') }}</td>
                            <td>{{ transaction.amount }}</td>
                            <td class="truncate">{{ transaction.reason or 'No reason provided' }}</td>
                            <td>{{ transaction.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Configuration Modal -->
<div id="configModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="configModalTitle">Edit Configuration</h3>
            <button class="btn btn-icon" onclick="closeConfigModal()">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <form id="configForm" method="POST" action="/admin/discord/bytes/config">
            <input type="hidden" name="action" value="update">
            <input type="hidden" name="guild_id" id="configGuildId">
            <div class="form-group">
                <label for="starting_balance">Starting Balance:</label>
                <input type="number" id="starting_balance" name="starting_balance" min="0" required>
            </div>
            <div class="form-group">
                <label for="daily_earning">Daily Earning:</label>
                <input type="number" id="daily_earning" name="daily_earning" min="0" required>
            </div>
            <div class="form-group">
                <label for="max_give_amount">Max Give Amount:</label>
                <input type="number" id="max_give_amount" name="max_give_amount" min="1" required>
            </div>
            <div class="form-group">
                <label for="cooldown_minutes">Cooldown (minutes):</label>
                <input type="number" id="cooldown_minutes" name="cooldown_minutes" min="1" required>
            </div>
            <div class="form-group">
                <label for="squad_join_bytes_required">Squad Join Min Bytes:</label>
                <input type="number" id="squad_join_bytes_required" name="squad_join_bytes_required" min="0" required>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeConfigModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<!-- Role Modal -->
<div id="roleModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="roleModalTitle">Add Role Reward</h3>
            <button class="btn btn-icon" onclick="closeRoleModal()">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <form id="roleForm" method="POST" action="/admin/discord/bytes/roles">
            <input type="hidden" name="action" value="create">
            <div class="form-group">
                <label for="guild_id">Server:</label>
                <select id="guild_id" name="guild_id" required>
                    <option value="">Select a server</option>
                    {% for guild in guilds %}
                    <option value="{{ guild.id }}">{{ guild.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="role_id">Role ID:</label>
                <input type="number" id="role_id" name="role_id" required>
                <span class="help-text">Discord role ID (right-click on role in Discord and select "Copy ID")</span>
            </div>
            <div class="form-group">
                <label for="role_name">Role Name:</label>
                <input type="text" id="role_name" name="role_name" required>
                <span class="help-text">Name of the role in Discord</span>
            </div>
            <div class="form-group">
                <label for="bytes_required">Bytes Required:</label>
                <input type="number" id="bytes_required" name="bytes_required" min="1" required>
                <span class="help-text">Number of bytes required to earn this role</span>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeRoleModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Role</button>
            </div>
        </form>
    </div>
</div>

<script>
function switchTab(tabId) {
    // Hide all tab content
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab and mark button as active
    document.getElementById(tabId).classList.add('active');
    event.currentTarget.classList.add('active');
}

// Configuration Modal Functions
function editConfig(configJson) {
    const config = JSON.parse(configJson);
    document.getElementById('configModalTitle').innerText = 'Edit Configuration';
    document.getElementById('configGuildId').value = config.guild_id;
    document.getElementById('starting_balance').value = config.starting_balance;
    document.getElementById('daily_earning').value = config.daily_earning;
    document.getElementById('max_give_amount').value = config.max_give_amount;
    document.getElementById('cooldown_minutes').value = config.cooldown_minutes;
    document.getElementById('squad_join_bytes_required').value = config.squad_join_bytes_required;
    
    document.getElementById('configModal').classList.add('active');
}

function closeConfigModal() {
    document.getElementById('configModal').classList.remove('active');
}

// Role Modal Functions
function openRoleModal() {
    document.getElementById('roleModalTitle').innerText = 'Add Role Reward';
    document.getElementById('roleForm').reset();
    document.getElementById('roleForm').action = '/admin/discord/bytes/roles';
    document.getElementById('roleForm').querySelector('input[name="action"]').value = 'create';
    document.getElementById('roleModal').classList.add('active');
}

function editRole(roleJson) {
    const role = JSON.parse(roleJson);
    document.getElementById('roleModalTitle').innerText = 'Edit Role Reward';
    document.getElementById('guild_id').value = role.guild_id;
    document.getElementById('role_id').value = role.role_id;
    document.getElementById('role_name').value = role.role_name;
    document.getElementById('bytes_required').value = role.bytes_required;
    
    document.getElementById('roleForm').action = `/admin/discord/bytes/roles/${role.id}`;
    document.getElementById('roleForm').querySelector('input[name="action"]').value = 'update';
    
    document.getElementById('roleModal').classList.add('active');
}

function closeRoleModal() {
    document.getElementById('roleModal').classList.remove('active');
}

function deleteRole(roleId) {
    if (confirm('Are you sure you want to delete this role reward?')) {
        fetch(`/admin/discord/bytes/roles/${roleId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        }).then(response => {
            if (response.ok) {
                window.location.reload();
            }
        });
    }
}

// History Filter Functions
function filterHistory() {
    const guildFilter = document.getElementById('guildFilter').value;
    const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
    const rows = document.getElementById('historyTable').getElementsByTagName('tr');
    
    for (let row of rows) {
        const guild = row.cells[2].textContent;
        const from = row.cells[0].textContent.toLowerCase();
        const to = row.cells[1].textContent.toLowerCase();
        const reason = row.cells[4].textContent.toLowerCase();
        
        const guildMatch = guildFilter === 'all' || guild === guildFilter;
        const searchMatch = !searchFilter || 
            from.includes(searchFilter) || 
            to.includes(searchFilter) || 
            reason.includes(searchFilter);
        
        row.style.display = guildMatch && searchMatch ? '' : 'none';
    }
}
</script>

<style>
.bytes-page {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
}

.tabs {
    display: flex;
    gap: var(--spacing-sm);
    border-bottom: 1px solid var(--border-color);
    padding-bottom: var(--spacing-sm);
}

.tab-btn {
    padding: var(--spacing-sm) var(--spacing-md);
    border: none;
    background: none;
    color: var(--text-secondary);
    cursor: pointer;
    border-radius: var(--radius-sm);
    transition: all 0.2s ease;
}

.tab-btn:hover {
    color: var(--text-primary);
    background-color: var(--bg-hover);
}

.tab-btn.active {
    color: var(--primary);
    background-color: var(--bg-active);
    font-weight: 500;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.filter-controls {
    display: flex;
    gap: var(--spacing-sm);
}

.form-select {
    padding: var(--spacing-sm) var(--spacing-md);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    background-color: var(--bg-primary);
    color: var(--text-primary);
    min-width: 150px;
}

.form-input {
    padding: var(--spacing-sm) var(--spacing-md);
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    background-color: var(--bg-primary);
    color: var(--text-primary);
    min-width: 200px;
}

.truncate {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}
</style>
{% endblock %}

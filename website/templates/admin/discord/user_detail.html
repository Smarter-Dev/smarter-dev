{% extends "admin/base.html" %}

{% block title %}User Details - Smarter.Dev Admin{% endblock %}

{% block content %}
<style>
    .bytes-action-section {
        background-color: var(--card-bg);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .bytes-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        align-items: end;
    }

    .bytes-form .form-group {
        margin-bottom: 0;
    }

    .bytes-form label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    .bytes-form input, .bytes-form select {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        background-color: var(--input-bg);
        color: var(--text-color);
    }

    .bytes-form button {
        padding: 0.5rem 1rem;
        height: 38px;
    }
</style>
<div class="user-detail-page">
    <div class="page-actions">
        <a href="/admin/discord/users" class="btn btn-outline">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="btn-icon">
                <line x1="19" y1="12" x2="5" y2="12"></line>
                <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
            Back to Users
        </a>
    </div>

    <div class="user-profile">
        <div class="user-header">
            <div class="user-avatar">
                {% if user.avatar_url %}
                <img src="{{ user.avatar_url }}" alt="{{ user.username }}">
                {% else %}
                <div class="avatar-placeholder">
                    {{ user.username[0].upper() }}
                </div>
                {% endif %}
            </div>
            <div class="user-info">
                <h2 class="user-name">{{ user.username }}</h2>
                <div class="user-id">ID: {{ user.discord_id }}</div>
                <div class="user-joined">Joined: {{ user.created_at.strftime('%Y-%m-%d') }}</div>
            </div>
        </div>

        <div class="user-stats">

            <div class="stat-item">
                <div class="stat-value">{{ bytes_balance }}</div>
                <div class="stat-label">Bytes Balance</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ bytes_received|length }}</div>
                <div class="stat-label">Bytes Received</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ bytes_given|length }}</div>
                <div class="stat-label">Bytes Given</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ warnings|length }}</div>
                <div class="stat-label">Warnings</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ mod_cases|length }}</div>
                <div class="stat-label">Mod Cases</div>
            </div>
        </div>

        <div class="user-guilds">
            <h3 class="section-title">Server Memberships</h3>
            <div class="guild-list">
                {% for membership in memberships %}
                <div class="guild-item">
                    <div class="guild-name">{{ guild_names[membership.guild_id] }}</div>
                    <div class="guild-joined">Joined: {{ membership.joined_at.strftime('%Y-%m-%d') if membership.joined_at else 'Unknown' }}</div>
                    <div class="guild-status">
                        <span class="status-badge {% if membership.is_active %}active{% else %}inactive{% endif %}">
                            {{ 'Active' if membership.is_active else 'Inactive' }}
                        </span>
                    </div>
                </div>
                {% endfor %}
                {% if not memberships %}
                <div class="empty-message">No server memberships found.</div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="tabs">
        <div class="tab-header">
            <button class="tab-button active" onclick="openTab(event, 'bytes-tab')">Bytes</button>
            <button class="tab-button" onclick="openTab(event, 'warnings-tab')">Warnings</button>
            <button class="tab-button" onclick="openTab(event, 'notes-tab')">Notes</button>
            <button class="tab-button" onclick="openTab(event, 'cases-tab')">Mod Cases</button>
        </div>



        <div id="bytes-tab" class="tab-content active">
            <h3 class="section-title">Bytes Received</h3>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>From</th>
                            <th>Amount</th>
                            <th>Reason</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for bytes in bytes_received %}
                        <tr>
                            <td>{% if bytes.giver and bytes.giver.discord_id == 0 %}System (Admin){% else %}{{ bytes.giver.username if bytes.giver else 'Unknown' }}{% endif %}</td>
                            <td>{{ bytes.amount }}</td>
                            <td class="truncate">{{ bytes.reason or 'No reason provided' }}</td>
                            <td>{{ bytes.awarded_at.strftime('%Y-%m-%d') }}</td>
                        </tr>
                        {% endfor %}
                        {% if not bytes_received %}
                        <tr>
                            <td colspan="4" class="empty-table">No bytes received.</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <div class="bytes-action-section">
                <h3 class="section-title">Give Bytes</h3>
                <form method="POST" action="/admin/discord/users/{{ user.id }}/give-bytes" class="bytes-form">
                    <div class="form-group">
                        <label for="amount">Amount:</label>
                        <input type="number" id="amount" name="amount" min="1" max="1000" value="10" required>
                    </div>
                    <div class="form-group">
                        <label for="reason">Reason:</label>
                        <input type="text" id="reason" name="reason" placeholder="Reason for giving bytes">
                    </div>
                    <div class="form-group">
                        <label for="guild_id">Server:</label>
                        <select id="guild_id" name="guild_id" required>
                            {% for guild_id, guild_name in guild_names.items() %}
                            <option value="{{ guild_id }}">{{ guild_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Give Bytes</button>
                </form>
            </div>

            <h3 class="section-title">Bytes Given</h3>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>To</th>
                            <th>Amount</th>
                            <th>Reason</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for bytes in bytes_given %}
                        <tr>
                            <td>{{ bytes.receiver.username if bytes.receiver else 'Unknown' }}</td>
                            <td>{{ bytes.amount }}</td>
                            <td class="truncate">{{ bytes.reason or 'No reason provided' }}</td>
                            <td>{{ bytes.awarded_at.strftime('%Y-%m-%d') }}</td>
                        </tr>
                        {% endfor %}
                        {% if not bytes_given %}
                        <tr>
                            <td colspan="4" class="empty-table">No bytes given.</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <div id="warnings-tab" class="tab-content">
            <h3 class="section-title">Warnings</h3>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Moderator</th>
                            <th>Reason</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for warning in warnings %}
                        <tr>
                            <td>{{ warning.moderator.username if warning.moderator else 'Unknown' }}</td>
                            <td class="truncate">{{ warning.reason or 'No reason provided' }}</td>
                            <td>{{ warning.warned_at.strftime('%Y-%m-%d') }}</td>
                        </tr>
                        {% endfor %}
                        {% if not warnings %}
                        <tr>
                            <td colspan="3" class="empty-table">No warnings.</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>

        <div id="notes-tab" class="tab-content">
            <h3 class="section-title">Moderator Notes</h3>
            <div class="notes-list">
                {% for note in notes %}
                <div class="note-item">
                    <div class="note-header">
                        <div class="note-author">{{ note.moderator.username if note.moderator else 'Unknown' }}</div>
                        <div class="note-date">{{ note.noted_at.strftime('%Y-%m-%d %H:%M') }}</div>
                    </div>
                    <div class="note-content">{{ note.content }}</div>
                </div>
                {% endfor %}
                {% if not notes %}
                <div class="empty-message">No moderator notes.</div>
                {% endif %}
            </div>
        </div>

        <div id="cases-tab" class="tab-content">
            <h3 class="section-title">Moderation Cases</h3>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Case #</th>
                            <th>Action</th>
                            <th>Moderator</th>
                            <th>Reason</th>
                            <th>Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for case in mod_cases %}
                        <tr>
                            <td>{{ case.case_number }}</td>
                            <td>{{ case.action }}</td>
                            <td>{{ case.moderator.username if case.moderator else 'Unknown' }}</td>
                            <td class="truncate">{{ case.reason or 'No reason provided' }}</td>
                            <td>{{ case.created_at.strftime('%Y-%m-%d') }}</td>
                            <td>
                                <span class="status-badge {% if case.resolved_at %}resolved{% else %}active{% endif %}">
                                    {{ 'Resolved' if case.resolved_at else 'Active' }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                        {% if not mod_cases %}
                        <tr>
                            <td colspan="6" class="empty-table">No moderation cases.</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    function openTab(evt, tabName) {
        // Hide all tab content
        const tabContents = document.getElementsByClassName('tab-content');
        for (let i = 0; i < tabContents.length; i++) {
            tabContents[i].classList.remove('active');
        }

        // Remove active class from all tab buttons
        const tabButtons = document.getElementsByClassName('tab-button');
        for (let i = 0; i < tabButtons.length; i++) {
            tabButtons[i].classList.remove('active');
        }

        // Show the selected tab content and mark the button as active
        document.getElementById(tabName).classList.add('active');
        evt.currentTarget.classList.add('active');
    }

    // Initialize with bytes tab active
    document.addEventListener('DOMContentLoaded', function() {
        // Make sure bytes tab is active by default
        document.getElementById('bytes-tab').classList.add('active');
        document.querySelector('.tab-button[onclick="openTab(event, \'bytes-tab\')"]').classList.add('active');
    });
</script>
{% endblock %}

{% extends "admin/base_sidebar.html" %}

{% block title %}Create Forum Agent - {{ guild.name }}{% endblock %}

{% block page_title %}Create Forum Agent{% endblock %}

{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="/admin/guilds">Guilds</a></li>
<li class="breadcrumb-item"><a href="/admin/guilds/{{ guild.id }}">{{ guild.name }}</a></li>
<li class="breadcrumb-item"><a href="/admin/guilds/{{ guild.id }}/forum-agents">Forum Agents</a></li>
<li class="breadcrumb-item active">Create Agent</li>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <form method="POST">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">
                        <svg class="icon me-2" width="24" height="24">
                            <use xlink:href="#tabler-robot"></use>
                        </svg>
                        Create New Forum Agent
                    </h3>
                </div>
                <div class="card-body">
                    <!-- Agent Name -->
                    <div class="mb-3">
                        <label class="form-label required">Agent Name</label>
                        <input type="text" name="name" class="form-control" placeholder="e.g. Support Helper" required maxlength="100">
                        <div class="form-hint">Give your agent a descriptive name</div>
                    </div>

                    <!-- Description -->
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <input type="text" name="description" class="form-control" placeholder="Brief description of what this agent does" maxlength="500">
                        <div class="form-hint">Optional description for admin reference</div>
                    </div>

                    <!-- System Prompt -->
                    <div class="mb-3">
                        <label class="form-label required">System Prompt</label>
                        <textarea name="system_prompt" class="form-control" rows="8" required placeholder="You are a helpful AI assistant that monitors forum posts. Your job is to...

Evaluate each post and decide if you should respond based on:
- Post content and context
- User's apparent needs
- Whether existing responses are adequate

If you decide to respond, provide a helpful, relevant response."></textarea>
                        <div class="form-hint">Define what the agent should look for and how it should respond</div>
                    </div>

                    <!-- Monitored Forums -->
                    <div class="mb-3">
                        <label class="form-label">Monitored Forum Channels</label>
                        <div id="forum-channels-container">
                            <div class="input-group mb-2">
                                <input type="text" name="monitored_forums[]" class="form-control" placeholder="Forum channel ID (e.g. 123456789)">
                                <button class="btn btn-outline-danger" type="button" onclick="removeForumChannel(this)" style="display: none;">
                                    <svg class="icon" width="16" height="16">
                                        <use xlink:href="#tabler-x"></use>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addForumChannel()">
                            <svg class="icon me-1" width="16" height="16">
                                <use xlink:href="#tabler-plus"></use>
                            </svg>
                            Add Another Channel
                        </button>
                        <div class="form-hint">Leave empty to monitor all forum channels</div>
                    </div>

                    <!-- User Tagging Configuration -->
                    <div class="card mb-3">
                        <div class="card-header">
                            <h4 class="card-title">
                                <svg class="icon me-2" width="20" height="20">
                                    <use xlink:href="#tabler-users"></use>
                                </svg>
                                User Tagging Settings
                            </h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-check">
                                            <input type="checkbox" name="enable_responses" class="form-check-input" checked onchange="updateOperationMode()">
                                            <span class="form-check-label">Generate AI responses to posts</span>
                                        </label>
                                        <div class="form-hint">Enable the agent to respond to forum posts</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-check">
                                            <input type="checkbox" name="enable_user_tagging" class="form-check-input" onchange="updateOperationMode()">
                                            <span class="form-check-label">Enable user tagging by topics</span>
                                        </label>
                                        <div class="form-hint">Allow users to subscribe to topic notifications</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Operation Mode Display -->
                            <div class="alert alert-info" id="operation-mode-alert">
                                <strong>Operation Mode:</strong> <span id="operation-mode">Response Only</span>
                                <br><small id="operation-mode-desc">This agent will evaluate posts and generate responses when appropriate.</small>
                            </div>

                            <!-- Topic Management (shown when tagging is enabled) -->
                            <div id="topic-management" style="display: none;">
                                <div class="mb-3">
                                    <label class="form-label">Notification Topics</label>
                                    <div id="topics-container">
                                        <div class="input-group mb-2">
                                            <input type="text" name="notification_topics[]" class="form-control topic-name-input" placeholder="Topic name (e.g. JavaScript, Python, Debugging)" maxlength="100">
                                            <input type="text" name="notification_topic_descriptions[]" class="form-control" placeholder="Optional description" maxlength="500">
                                            <button class="btn btn-outline-danger" type="button" tabindex="-1" onclick="removeTopic(this)" style="display: none;">
                                                <svg class="icon" width="16" height="16">
                                                    <use xlink:href="#tabler-x"></use>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addTopic()">
                                        <svg class="icon me-1" width="16" height="16">
                                            <use xlink:href="#tabler-plus"></use>
                                        </svg>
                                        Add Topic
                                    </button>
                                    <div class="form-hint">Create topics that users can subscribe to (max 25 per forum)</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Settings -->
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title">Advanced Settings</h4>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Response Threshold</label>
                                        <input type="range" name="response_threshold" class="form-range" min="0" max="1" step="0.1" value="0.7" oninput="updateThresholdValue(this.value)">
                                        <div class="d-flex justify-content-between text-muted small">
                                            <span>Low (0%)</span>
                                            <span id="threshold-value">70%</span>
                                            <span>High (100%)</span>
                                        </div>
                                        <div class="form-hint">Confidence threshold for responding to posts</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Max Responses Per Hour</label>
                                        <input type="number" name="max_responses_per_hour" class="form-control" min="1" max="100" value="5">
                                        <div class="form-hint">Rate limit to prevent spam</div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-check">
                                    <input type="checkbox" name="is_active" class="form-check-input" checked>
                                    <span class="form-check-label">Activate agent immediately</span>
                                </label>
                                <div class="form-hint">Agent will start monitoring as soon as it's created</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer text-end">
                    <div class="d-flex">
                        <a href="/admin/guilds/{{ guild.id }}/forum-agents" class="btn btn-link">Cancel</a>
                        <button type="submit" class="btn btn-primary ms-auto">
                            <svg class="icon me-2" width="16" height="16">
                                <use xlink:href="#tabler-device-floppy"></use>
                            </svg>
                            Create Agent
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
function addForumChannel() {
    const container = document.getElementById('forum-channels-container');
    const div = document.createElement('div');
    div.className = 'input-group mb-2';
    div.innerHTML = `
        <input type="text" name="monitored_forums[]" class="form-control" placeholder="Forum channel ID (e.g. 123456789)">
        <button class="btn btn-outline-danger" type="button" onclick="removeForumChannel(this)">
            <svg class="icon" width="16" height="16">
                <use xlink:href="#tabler-x"></use>
            </svg>
        </button>
    `;
    container.appendChild(div);
    updateRemoveButtons();
}

function removeForumChannel(button) {
    button.parentElement.remove();
    updateRemoveButtons();
}

function updateRemoveButtons() {
    const removeButtons = document.querySelectorAll('#forum-channels-container .btn-outline-danger');
    removeButtons.forEach((button, index) => {
        button.style.display = removeButtons.length > 1 ? 'block' : 'none';
    });
}

function addTopic() {
    const container = document.getElementById('topics-container');
    const topicCount = container.children.length;
    
    if (topicCount >= 25) {
        alert('Maximum 25 topics allowed per forum');
        return;
    }
    
    const div = document.createElement('div');
    div.className = 'input-group mb-2';
    div.innerHTML = `
        <input type="text" name="notification_topics[]" class="form-control topic-name-input" placeholder="Topic name (e.g. JavaScript, Python, Debugging)" maxlength="100">
        <input type="text" name="notification_topic_descriptions[]" class="form-control" placeholder="Optional description" maxlength="500">
        <button class="btn btn-outline-danger" type="button" tabindex="-1" onclick="removeTopic(this)">
            <svg class="icon" width="16" height="16">
                <use xlink:href="#tabler-x"></use>
            </svg>
        </button>
    `;
    container.appendChild(div);
    updateTopicRemoveButtons();
    
    // Focus the newly created topic name input
    const newTopicInput = div.querySelector('.topic-name-input');
    if (newTopicInput) {
        newTopicInput.focus();
    }
}

function removeTopic(button) {
    button.parentElement.remove();
    updateTopicRemoveButtons();
}

function updateTopicRemoveButtons() {
    const removeButtons = document.querySelectorAll('#topics-container .btn-outline-danger');
    removeButtons.forEach((button, index) => {
        button.style.display = removeButtons.length > 1 ? 'block' : 'none';
    });
}

function updateOperationMode() {
    const enableResponses = document.querySelector('input[name="enable_responses"]').checked;
    const enableTagging = document.querySelector('input[name="enable_user_tagging"]').checked;
    const topicManagement = document.getElementById('topic-management');
    const operationMode = document.getElementById('operation-mode');
    const operationModeDesc = document.getElementById('operation-mode-desc');
    
    if (enableResponses && enableTagging) {
        operationMode.textContent = 'Combined Mode';
        operationModeDesc.textContent = 'This agent will both respond to posts and classify them into topics for user notifications.';
        topicManagement.style.display = 'block';
    } else if (enableTagging) {
        operationMode.textContent = 'Tagging Only';
        operationModeDesc.textContent = 'This agent will classify posts into topics for user notifications but won\'t generate responses.';
        topicManagement.style.display = 'block';
    } else {
        operationMode.textContent = 'Response Only';
        operationModeDesc.textContent = 'This agent will evaluate posts and generate responses when appropriate.';
        topicManagement.style.display = 'none';
    }
}

function updateThresholdValue(value) {
    document.getElementById('threshold-value').textContent = Math.round(value * 100) + '%';
}

// Initialize everything on page load
document.addEventListener('DOMContentLoaded', function() {
    updateRemoveButtons();
    updateTopicRemoveButtons();
    updateOperationMode();
});
</script>
{% endblock %}
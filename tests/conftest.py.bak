import pytest
from starlette_testclient import TestClient
import os
import sys

# Add the project root to the path so we can import the website package
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from website.app import app
from website.database import Base, engine, get_db
from website.models import AdminUser, Redirect
from website.auth import get_password_hash

@pytest.fixture
def client():
    """
    Create a test client for the app
    """
    with TestClient(app) as client:
        yield client

@pytest.fixture
def test_db():
    """
    Create a fresh database for each test
    """
    # Create tables
    Base.metadata.create_all(bind=engine)

    # Create test data
    db = next(get_db())

    # Create admin user
    admin_user = AdminUser(
        username="testadmin",
        email="testadmin@example.com",
        hashed_password=get_password_hash("testpassword"),
        is_active=True
    )
    db.add(admin_user)

    # Create test redirect
    test_redirect = Redirect(
        name="test",
        target_url="https://example.com",
        description="Test redirect",
        is_active=True
    )
    db.add(test_redirect)

    db.commit()

    yield db

    # Clean up
    db.close()
    Base.metadata.drop_all(bind=engine)
